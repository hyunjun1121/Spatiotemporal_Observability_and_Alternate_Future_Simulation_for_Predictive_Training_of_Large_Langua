# Spatiotemporal Observability 연구 실행 가이드

## 0. Repo/디렉토리 초기화
- `./related_work/` : 선행연구 PDF 저장 (위 제안 파일명 사용)
- `./src/` : 코드 (PyTorch or JAX)
  - `train/` : 기본 training loop
  - `monitor/` : metrics & anomaly detectors (uncertainty index)
  - `proxy/` : training dynamics proxy
  - `branch/` : branch simulation orchestrator
  - `cp/` : quantum checkpointing (save/load)
  - `eval/` : validators, metrics
- `./runs/` : 실험 결과(원본 역사)
- `./branches/` : 분기 시뮬레이션 결과(가상 미래)
- `./assets/` : 설정, schema, 그림
- `./notes/` : 실험 노트(마크다운)

## 1. Baseline 준비 (Phase 1: ≤1B 파라미터 LM)
1.1 **Model**: GPT-2 medium ~ large, T5-base (open weights).  
1.2 **Data**: 공개 corpus (WikiText103 등) + synthetic noise로 **instability** 유발 세트 준비.  
1.3 **Trainer**: PyTorch `DistributedDataParallel`, **mixed precision (bf16)**.  
1.4 **Determinism**: `RNG seed`(Python/NumPy/torch/CUDA), **dataloader sampler state**, **LR scheduler state** 모두 save/restore.
- 파일: `./assets/state_schema_v1.yaml`에 **state vector** 스키마 정의:
  - `model_state_dict`, `optimizer_state_dict`, `lr_scheduler_state`
  - `dataloader_rng_state`, `python_rng`, `numpy_rng`, `torch_rng`, `cuda_rng`
  - `sampler_indices_offset`, `epoch`, `global_step`
  - (옵션) 최근 `k` step의 **grad/activation summary** (EMA 통계)

## 2. Quantum Checkpointing (CP)
2.1 **주기**: 기본 `every 1k steps` (configurable).  
2.2 **형식**: `cp_{global_step}.ptz` (압축: zstd).  
2.3 **경량화**: 
- optimizer moments는 **8-bit quantization** 옵션 제공.
- activation은 저장하지 않되, **summary stats**(mean/std/entropy by layer)만 기록.
- 참고: activation checkpointing/RevNet 아이디어로 **메모리 피크** 완화 (대규모 확장 대비).

## 3. Uncertainty Index (Trigger) 설계
지표 3종을 **z-score normalization** 후 가중합:
- **Short-term volatility**: `loss`의 EMA 대비 **residual**, `gradient norm` 변화율.
- **Internal state entropy**: attention entropy, key layer activation entropy.
- **Predictive disagreement**: 소형 **time-series forecaster**(LSTM/GRU × K)의 `N-step loss forecast variance`.
설정: `index = w1*vol + w2*entropy + w3*disagree`; `index > τ`이면 **branch simulation** 발동.
- 파일: `./assets/uncertainty_config.yaml` (w, τ, EMA decay 등).

## 4. Proxy (Training Dynamics) 모델 (Phase 1.5)
4.1 **Input feature** (per step or window W):
- scalar: `loss`, `grad_norm`, `lr`, `weight_decay`, `clip_bound`, `momentum_reset_flag`, `batch_stats`(mean/var)
- vector summary: per-layer `activation entropy`, `attention entropy`
- historical features: EMA/Δ of 위 지표들
4.2 **Action encoding**:
- `Δlr ∈ {−20%, −10%, 0, +10%}`, `weight_decay ×{0.5,1,2}`, `clip policy ∈ {off, ZClip, ARC, SPAM-clip}`, `momentum_reset ∈ {0,1}`, `data_reorder ∈ {none, shuffle_block}`, `skip_batch ∈ {0,1}`(주의)
4.3 **Target**:
- `E[loss@+N]`, `prob(divergence@+N)`, `instability_risk_score`, `recovery_time`
4.4 **Model**: 작은 **MLP/Transformer encoder** (LayerNorm + GELU), horizon `N=500~5k`.
4.5 **Training data**: baseline run에서 수집한 `(state, action) → future metrics` tuples.
- 저장: `./runs/log_db.parquet` (schema 명세 `./assets/log_schema.json`)
4.6 **Calibration**: **conformal prediction**로 `risk quantile` 보정.

## 5. Branch Simulation Orchestrator
5.1 **트리거 발생** → `cp_{t-1000}` 로드.  
5.2 **Action set** 생성: 위 action grid에서 **Bayesian optimization** or **bandit**로 50~500개 샘플.
5.3 **Proxy rollout**: 각 action에 대해 horizon `N` 예측 → **score** 산출
- `score = α*(-E[loss@N]) + β*(-risk) + γ*(-recovery_time)` (maximize)
5.4 **Top-K** 후보(예: 5~10개)에 한해 **partial real rollout**(실모델 소수 step, 예: +50)로 **verification** (speculative decoding의 **accept/reject** 유사 절차).
5.5 **Collapse**: 최종 1개 action 채택 → **실제 훈련**에 적용.
- 저장: `./branches/{t}/` 에 simulation meta 및 선택 사유 기록 (`decision.json`)

## 6. Metrics & Evaluation
- **Primary**: 최종 `validation perplexity`, `instability events per 100k steps`, `time-to-recover`(trigger→안정화), `wasted FLOPs` 감소율.
- **Secondary**: branch invoke rate, proxy inference latency, checkpoint I/O time.
- 시각화: `./notes/figs/*.png` (loss, index, decisions timeline).

## 7. Baselines / Ablations
- Baselines: **PBT**, **fixed LR schedule**, **Hypergradient Descent**, **SPAM**, **ZClip**, **ARC**.
- Ablations:
  - (A) proxy 없음 (rule-based actions만)
  - (B) proxy 있음 + verification 없음
  - (C) proxy 있음 + verification 있음 (**full method**)
  - (D) trigger 단일지표 vs. **uncertainty index**
- 보고: `./notes/report_phase1.md`

## 8. Engineering 지침
- **I/O**: checkpoint는 zstd + tensor chunking, CPU pinned I/O thread.
- **Scheduler**: Slurm/Ray로 branch batch 병렬화. proxy inference는 CPU/1GPU로 분리.
- **Reproducibility**: 모든 branch에 `seed_manifest.json` 저장.
- **Safety**: `skip_batch`는 **data bias** 유발 가능 → 기본 off, 실험적으로만 on.

## 9. Phase 2 (RL/LLM Agent) 확장
- 대상: **Decision Transformer** 또는 **RLHF** 중 pretraining → PPO 미세단계.
- Proxy target을 `expected return@N`, `value variance`로 확장.
- Branch actions에 **entropy bonus**, **KL penalty**, **reference model LR** 조합 추가.

## 10. 파일명/저장 규칙
- 논문: `YYYY_AuthorKey_Topic.pdf` (예: `2017_Jaderberg_PBT.pdf`) → `./related_work/`
- 체크포인트: `./runs/checkpoints/cp_{global_step}.ptz`
- 분기: `./branches/{t}/candidate_{id}.json`, `verification_{id}.log`
- 로그DB: `./runs/log_db.parquet`
- 설정: `./assets/*.yaml`, `./assets/*.json`

## 11. 성공 기준 & 마일스톤
- M1: baseline 대비 **instability events** 30%↓, **wasted FLOPs** 20%↓
- M2: 동일 compute로 **val perplexity** 유의 개선 (t-test, p<0.05)
- M3: RL setting에서 **expected return** 향상 및 **catastrophic divergence** 빈도 감소

## 12. 리스크 & 완화
- Proxy miscalibration → **verification** 단계 강화, conformal band 확장.
- I/O 병목 → checkpoint 간격 증가(1k→2k), proxy-only prune 비율 상향.
- False positives trigger → τ 상향/히스테리시스 도입.

